{% extends "base.html" %}
{% load static %}

{% block title %}{{ movie.title }} | MovieMeter{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{% static 'movies/detail.css' %}">
{% endblock %}

{% block navbar %}
  {% include "includes/navbar.html" with mode="mini" %}
{% endblock %}

{% block content %}

<div class="detail-page">

  <!-- HERO -->
  <section class="movie-hero">

    <div class="poster">
      {% if movie.poster_path %}
        <img src="https://image.tmdb.org/t/p/w500{{ movie.poster_path }}" alt="{{ movie.title }}">
      {% else %}
        <div class="no-poster">No Image</div>
      {% endif %}
    </div>

    <div class="movie-info">
      <h1>{{ movie.title }}</h1>

      <p class="meta">
        {% if movie.release_date %}
          <span class="meta-date">{{ movie.release_date }}</span>
        {% endif %}

        {% if movie.is_released %}
          <span class="status-pill released">Released</span>
        {% else %}
          <span class="status-pill upcoming">Upcoming</span>
        {% endif %}
      </p>

      {% if movie.overview %}
        <p class="overview">{{ movie.overview }}</p>
      {% else %}
        <p class="overview muted">No overview available.</p>
      {% endif %}

      <div class="genres">
        {% for g in movie.categories.all %}
          <span>{{ g.name }}</span>
        {% endfor %}
      </div>

      <!-- Watchlist -->
      <button
        id="watchlist-btn"
        type="button"
        class="watchlist-btn {% if in_watchlist %}added{% endif %}"
        data-movie-id="{{ movie.id }}"
      >
        {% if in_watchlist %}‚úì In Watchlist{% else %}+ Add to Watchlist{% endif %}
      </button>

    </div>
  </section>

  <!-- OPINION METER -->
  <section class="meter-section">
    <div class="meter-wrap">

      <div class="meter-head">
        <div>
          <h2>Audience Opinion</h2>
          <p class="meter-subtitle">Tap any option to vote üëá</p>
        </div>

        <!-- ‚úÖ Vote pill + tooltip -->
        <div class="vote-pill-wrap">
          <div class="vote-pill" id="vote-pill">üó≥Ô∏è Vote Now</div>

          <div class="vote-tooltip">
            <div class="tooltip-title">Vote Breakdown</div>

            <div class="tooltip-row bad">
              <span>Bad</span>
              <span id="tt-bad">0</span>
            </div>

            <div class="tooltip-row average">
              <span>Average</span>
              <span id="tt-average">0</span>
            </div>

            <div class="tooltip-row good">
              <span>Good</span>
              <span id="tt-good">0</span>
            </div>

            <div class="tooltip-row masterpiece">
              <span>Masterpiece</span>
              <span id="tt-masterpiece">0</span>
            </div>

            <div class="tooltip-total">
              Total: <strong id="tt-total">0</strong>
            </div>
          </div>
        </div>
      </div>

      <div class="meter-container">

        <div class="meter-row bad meter-bar"
            data-vote="bad"
            data-label="Bad"
            data-percent="{{ vote_percents.bad }}"
            data-votes="{{ vote_counts.bad }}">
          <span class="meter-name">Bad</span>
          <div class="meter-track"><div class="fill"></div></div>
          <span class="meter-pct">{{ vote_percents.bad }}%</span>
        </div>

        <div class="meter-row average meter-bar"
            data-vote="average"
            data-label="Average"
            data-percent="{{ vote_percents.average }}"
            data-votes="{{ vote_counts.average }}">
          <span class="meter-name">Average</span>
          <div class="meter-track"><div class="fill"></div></div>
          <span class="meter-pct">{{ vote_percents.average }}%</span>
        </div>

        <div class="meter-row good meter-bar"
            data-vote="good"
            data-label="Good"
            data-percent="{{ vote_percents.good }}"
            data-votes="{{ vote_counts.good }}">
          <span class="meter-name">Good</span>
          <div class="meter-track"><div class="fill"></div></div>
          <span class="meter-pct">{{ vote_percents.good }}%</span>
        </div>

        <div class="meter-row masterpiece meter-bar"
            data-vote="masterpiece"
            data-label="Masterpiece"
            data-percent="{{ vote_percents.masterpiece }}"
            data-votes="{{ vote_counts.masterpiece }}">
          <span class="meter-name">Masterpiece</span>
          <div class="meter-track"><div class="fill"></div></div>
          <span class="meter-pct">{{ vote_percents.masterpiece }}%</span>
        </div>

        

      </div>
    </div>
  </section>

  <!-- CAST -->
  {% if movie.cast.exists %}
  <section class="cast-section">
    <h2>Cast</h2>

    <div class="cast-list">
      {% for member in movie.cast.all %}
        <a href="{% url 'person-detail' member.person.id %}" class="cast-card-link">
          <div class="cast-card">

            {% if member.person.profile_path %}
              <img
                src="https://image.tmdb.org/t/p/w200{{ member.person.profile_path }}"
                alt="{{ member.person.name }}"
              >
            {% else %}
              <div class="cast-avatar">üé≠</div>
            {% endif %}

            <p class="cast-name">{{ member.person.name }}</p>
            <span class="cast-role">{{ member.character }}</span>

          </div>
        </a>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  <!-- CREW -->
  {% if movie.crew.exists %}
  <section class="cast-section">
    <h2>Crew</h2>

    <div class="cast-list">
      {% for member in movie.crew.all %}
        <a href="{% url 'person-detail' member.person.id %}" class="cast-card-link">
          <div class="cast-card">

            {% if member.person.profile_path %}
              <img
                src="https://image.tmdb.org/t/p/w200{{ member.person.profile_path }}"
                alt="{{ member.person.name }}"
              >
            {% else %}
              <div class="cast-avatar">üé¨</div>
            {% endif %}

            <p class="cast-name">{{ member.person.name }}</p>
            <span class="cast-role">{{ member.job }}</span>

          </div>
        </a>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  <!-- REVIEW FORM -->
  <section class="review-form">
    <h2>Rate & Review</h2>

    {% if user.is_authenticated %}
      <form id="review-form" method="post" action="{% url 'submit-review' movie.id %}">
        {% csrf_token %}

        <div class="stars" id="stars">
          <span class="star" data-value="1">‚òÖ</span>
          <span class="star" data-value="2">‚òÖ</span>
          <span class="star" data-value="3">‚òÖ</span>
          <span class="star" data-value="4">‚òÖ</span>
          <span class="star" data-value="5">‚òÖ</span>

          <span class="rating-text" id="rating-text">Select rating</span>
        </div>

        <input type="hidden" name="rating" id="rating-input" value="0">

        <textarea
          name="review_text"
          placeholder="Write your review..."
          required
        ></textarea>

        <button type="submit">Submit Review</button>
      </form>

    {% else %}
      <p class="login-hint">Login to write a review</p>
    {% endif %}
  </section>

</div>
<script>
/* =========================
   STABLE VOTE UX (FINAL + TOGGLE)
========================= */

const bars = document.querySelectorAll(".meter-bar");
const votePill = document.getElementById("vote-pill");

// Tooltip counts
const ttBad = document.getElementById("tt-bad");
const ttAverage = document.getElementById("tt-average");
const ttGood = document.getElementById("tt-good");
const ttMasterpiece = document.getElementById("tt-masterpiece");
const ttTotal = document.getElementById("tt-total");

const labels = {
  bad: "Bad",
  average: "Average",
  good: "Good",
  masterpiece: "Masterpiece",
};

// üîí single source of truth
let lockedVoteKey = null;

/* =========================
   HELPERS
========================= */

function animateBars() {
  bars.forEach(bar => {
    bar.querySelector(".fill").style.width =
      (bar.dataset.percent || 0) + "%";
  });
}

function totalVotes() {
  let t = 0;
  bars.forEach(b => t += Number(b.dataset.votes || 0));
  return t;
}

function votesFor(key) {
  return [...bars].find(b => b.dataset.vote === key)?.dataset.votes || 0;
}

function clearBarState() {
  bars.forEach(b => {
    b.classList.remove(
      "active",
      "selected-bad",
      "selected-average",
      "selected-good",
      "selected-masterpiece"
    );
  });
}

function lockBar(key) {
  clearBarState();
  if (!key) return;
  bars.forEach(b => {
    if (b.dataset.vote === key) {
      b.classList.add("active", `selected-${key}`);
    }
  });
}

function setVotePill(key) {
  votePill.className = "vote-pill";
  if (key) {
    votePill.textContent = `Voted: ${labels[key]}`;
    votePill.classList.add(`pill-${key}`);
  } else {
    votePill.textContent = "üó≥Ô∏è Vote Now";
  }
}

function updateTooltip() {
  ttBad.textContent = votesFor("bad");
  ttAverage.textContent = votesFor("average");
  ttGood.textContent = votesFor("good");
  ttMasterpiece.textContent = votesFor("masterpiece");
  ttTotal.textContent = totalVotes();
}

/* =========================
   INITIAL LOAD (NO DEFAULT)
========================= */

window.addEventListener("load", () => {
  animateBars();
  updateTooltip();

  const alreadyVoted = "{{ user_vote }}".trim();

  if (alreadyVoted) {
    lockedVoteKey = alreadyVoted;
    setVotePill(alreadyVoted);
    lockBar(alreadyVoted);
  } else {
    lockedVoteKey = null;
    setVotePill(null);
    clearBarState();
  }
});

/* =========================
   CLICK ‚Üí TOGGLE (YT STYLE)
========================= */

bars.forEach(bar => {
  bar.addEventListener("click", async () => {
    const voteKey = bar.dataset.vote;

    // üîÅ toggle logic
    const isRemoving = lockedVoteKey === voteKey;
    const payloadVote = isRemoving ? "remove" : voteKey;

    try {
      const res = await fetch("{% url 'vote-movie' movie.id %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": "{{ csrf_token }}",
        },
        body: `vote=${payloadVote}`,
      });

      const data = await res.json();
      if (!res.ok || data.error) {
        alert("Vote failed");
        return;
      }

      // backend = source of truth
      bars.forEach(b => {
        b.dataset.votes = data.counts[b.dataset.vote];
        b.dataset.percent = data.percents[b.dataset.vote];
      });

      animateBars();
      updateTooltip();

      // REMOVE vote
      if (isRemoving) {
        lockedVoteKey = null;
        setVotePill(null);
        clearBarState();
      }
      // ADD / CHANGE vote
      else {
        lockedVoteKey = voteKey;
        setVotePill(voteKey);
        lockBar(voteKey);
      }

    } catch (e) {
      console.error("Vote JS error:", e);
      alert("Something broke. Check console.");
    }
  });
});








/* =========================
   WATCHLIST TOGGLE
========================= */

/* =========================
   WATCHLIST TOGGLE (FIXED)
========================= */

const watchlistBtn = document.getElementById("watchlist-btn");

if (watchlistBtn) {
  watchlistBtn.addEventListener("click", async () => {
    try {
      const res = await fetch("{% url 'toggle-watchlist' movie.id %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
        },
      });

      if (!res.ok) {
        throw new Error("HTTP " + res.status);
      }

      const data = await res.json();

      if (data.status === "added") {
        watchlistBtn.classList.add("added");
        watchlistBtn.textContent = "‚úì In Watchlist";
      } else if (data.status === "removed") {
        watchlistBtn.classList.remove("added");
        watchlistBtn.textContent = "+ Add to aWatchlist";
      }

    } catch (e) {
      console.error("Watchlist error:", e);
      alert("Something broke. Check console.");
    }
  });
}


/* =========================
   STAR RATING (UI ONLY)
========================= */

const stars = document.querySelectorAll(".star");
const ratingInput = document.getElementById("rating-input");
const ratingText = document.getElementById("rating-text");

function updateStars(value) {
  stars.forEach(star => {
    const starValue = Number(star.dataset.value);
    star.classList.toggle("active", starValue <= value);
  });
}

stars.forEach(star => {
  star.addEventListener("click", () => {
    const value = Number(star.dataset.value);
    ratingInput.value = value;
    ratingText.textContent = `${value} / 5`;
    updateStars(value);
  });
});


const reviewForm = document.getElementById("review-form");

reviewForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  const formData = new FormData(reviewForm);

  const res = await fetch(reviewForm.action, {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}",
    },
    body: formData,
  });

  const data = await res.json();

  if (!res.ok) {
    alert(data.error || "Review failed");
    return;
  }

  location.reload(); 
});


</script>



{% endblock %}
