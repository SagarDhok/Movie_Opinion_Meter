{% extends "base.html" %}
{% load static %}

{% block title %}{{ movie.title }} | MovieMeter{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{% static 'movies/detail.css' %}">
{% endblock %}
{% block navbar %}
  {% include "includes/navbar.html" with mode="mini" %}
{% endblock %}


{% block content %}

<div class="detail-page">

  <!-- HERO -->
  <section class="movie-hero">

    <div class="poster">
      {% if movie.poster_path %}
        <img src="https://image.tmdb.org/t/p/w500{{ movie.poster_path }}" alt="{{ movie.title }}">
      {% else %}
        <div class="no-poster">No Image</div>
      {% endif %}
    </div>

    <div class="movie-info">
      <h1>{{ movie.title }}</h1>

      <p class="meta">
        {% if movie.release_date %}
          <span class="meta-date">{{ movie.release_date }}</span>
        {% endif %}

        {% if movie.is_released %}
          <span class="status-pill released">Released</span>
        {% else %}
          <span class="status-pill upcoming">Upcoming</span>
        {% endif %}
      </p>

      <!-- Overview -->
      {% if movie.overview %}
        <p class="overview">{{ movie.overview }}</p>
      {% else %}
        <p class="overview muted">No overview available.</p>
      {% endif %}

      <!-- Genres -->
      <div class="genres">
        {% for g in movie.categories.all %}
          <span>{{ g.name }}</span>
        {% endfor %}
      </div>

      <!-- Watchlist -->
       <button
  id="watchlist-btn"
  class="watchlist-btn {% if in_watchlist %}added{% endif %}"
  data-movie-id="{{ movie.id }}"
>
  {% if in_watchlist %}‚úì In Watchlist{% else %}+ Add to Watchlist{% endif %}
</button>

    </div>

  </section>

  <!-- OPINION METER -->
  <section class="meter-section">

    <div class="meter-wrap">

      <div class="meter-head">
        <div>
          <h2>Audience Opinion</h2>
          <p class="meter-subtitle">Tap any option to vote üëá</p>
        </div>

        <div class="vote-pill" id="vote-pill">üó≥Ô∏è Vote Now</div>
      </div>

      <div class="meter-container">

        <div class="meter-row bad meter-bar" data-label="Bad" data-percent="5" data-votes="34">
          <span class="meter-name">Bad</span>
          <div class="meter-track"><div class="fill"></div></div>
          <span class="meter-pct">5%</span>
        </div>

        <div class="meter-row average meter-bar" data-label="Average" data-percent="20" data-votes="224">
          <span class="meter-name">Average</span>
          <div class="meter-track"><div class="fill"></div></div>
          <span class="meter-pct">20%</span>
        </div>

        <div class="meter-row good meter-bar" data-label="Good" data-percent="55" data-votes="765">
          <span class="meter-name">Good</span>
          <div class="meter-track"><div class="fill"></div></div>
          <span class="meter-pct">55%</span>
        </div>

        <div class="meter-row masterpiece meter-bar" data-label="Masterpiece" data-percent="20" data-votes="98">
          <span class="meter-name">Masterpiece</span>
          <div class="meter-track"><div class="fill"></div></div>
          <span class="meter-pct">20%</span>
        </div>

        <div class="summary">
          <div class="overall-summary" id="overall-summary">
            Overall ‚Üí Good (55%) ‚Äî 765 votes out of 1121
          </div>
          <div class="user-vote" id="user-vote"></div>
        </div>

      </div>

    </div>

  </section>

  <!-- CAST -->
 {% if movie.cast.exists %}
<section class="cast-section">
  <h2>Cast</h2>

  <div class="cast-list">
    {% for member in movie.cast.all %}
      <a href="{% url 'person-detail' member.person.id %}" class="cast-card-link">
        <div class="cast-card">

          {% if member.person.profile_path %}
            <img
              src="https://image.tmdb.org/t/p/w200{{ member.person.profile_path }}"
              alt="{{ member.person.name }}"
            >
          {% else %}
            <div class="cast-avatar">üé≠</div>
          {% endif %}

          <p class="cast-name">{{ member.person.name }}</p>
          <span class="cast-role">{{ member.character }}</span>

        </div>
      </a>
    {% endfor %}
  </div>
</section>
{% endif %}


  <!-- CREW -->
{% if movie.crew.exists %}
<section class="cast-section">
  <h2>Crew</h2>

  <div class="cast-list">
    {% for member in movie.crew.all %}
      <a href="{% url 'person-detail' member.person.id %}" class="cast-card-link">
        <div class="cast-card">

          {% if member.person.profile_path %}
            <img
              src="https://image.tmdb.org/t/p/w200{{ member.person.profile_path }}"
              alt="{{ member.person.name }}"
            >
          {% else %}
            <div class="cast-avatar">üé¨</div>
          {% endif %}

          <p class="cast-name">{{ member.person.name }}</p>
          <span class="cast-role">{{ member.job }}</span>

        </div>
      </a>
    {% endfor %}
  </div>
</section>
{% endif %}


  <!-- REVIEW FORM -->
  <section class="review-form">
    <h2>Rate & Review</h2>

    {% if user.is_authenticated %}
      <form>
        <div class="stars" id="stars">
          <span class="star" data-value="1">‚òÖ</span>
          <span class="star" data-value="2">‚òÖ</span>
          <span class="star" data-value="3">‚òÖ</span>
          <span class="star" data-value="4">‚òÖ</span>
          <span class="star" data-value="5">‚òÖ</span>

          <span class="rating-text" id="rating-text">Select rating</span>
        </div>

        <input type="hidden" name="rating" id="rating-input" value="0">

        <textarea placeholder="Write your review..."></textarea>
        <button type="submit">Submit Review</button>
      </form>
    {% else %}
      <p class="login-hint">Login to write a review</p>
    {% endif %}
  </section>

</div>

<script>
  // =========================
  // Audience Meter (click vote)
  // =========================
  const bars = document.querySelectorAll(".meter-bar");
  const overallSummary = document.getElementById("overall-summary");
  const userVote = document.getElementById("user-vote");
  const votePill = document.getElementById("vote-pill");

  const colors = {
    Bad: "#fb7185",
    Average: "#facc15",
    Good: "#34d399",
    Masterpiece: "#a855f7"
  };

  window.addEventListener("load", () => {
    bars.forEach(bar => {
      const pct = bar.dataset.percent;
      bar.querySelector(".fill").style.width = pct + "%";
    });

    overallSummary.innerHTML = `üé¨ <strong>Overall ‚Üí Good (55%)</strong> ‚Äî 765 votes out of 1121`;
  });

  bars.forEach(bar => {
    bar.addEventListener("click", () => {
      bars.forEach(b => b.classList.remove("active"));
      bar.classList.add("active");

      const label = bar.dataset.label;
      const votes = bar.dataset.votes;
      const percent = bar.dataset.percent;
      const total = 1121;

      votePill.innerHTML = `Voted: ${label}`;

      userVote.innerHTML =
        `üó≥Ô∏è <strong>You voted:</strong> <span style="color:${colors[label]}; font-weight:900;">${label}</span>
         <span style="color: rgba(148,163,184,0.9);">(${percent}%)</span>
         ‚Äî ${votes} votes out of ${total}`;

      userVote.classList.add("show");
    });
  });

  // =========================
  // Stars rating (Google Play style)
  // =========================
  const starEls = document.querySelectorAll(".star");
  const ratingText = document.getElementById("rating-text");
  const ratingInput = document.getElementById("rating-input");

  let selectedRating = 0;

  const ratingLabels = {
    1: "Poor",
    2: "Average",
    3: "Good",
    4: "Great",
    5: "Masterpiece"
  };

  function paintStars(rating) {
    starEls.forEach((s, index) => {
      if (index < rating) {
        s.classList.add("active");
      } else {
        s.classList.remove("active");
      }
    });
  }

  starEls.forEach((star) => {
    const value = Number(star.dataset.value);

    star.addEventListener("mouseover", () => {
      paintStars(value);
      ratingText.textContent = ratingLabels[value];
    });

    star.addEventListener("mouseout", () => {
      paintStars(selectedRating);
      ratingText.textContent = selectedRating ? ratingLabels[selectedRating] : "Select rating";
    });

    star.addEventListener("click", () => {
      selectedRating = value;
      ratingInput.value = selectedRating;
      paintStars(selectedRating);
      ratingText.textContent = ratingLabels[selectedRating];
    });
  });



const watchlistBtn = document.getElementById("watchlist-btn");

if (watchlistBtn) {
  watchlistBtn.addEventListener("click", () => {
    const movieId = watchlistBtn.dataset.movieId;

    fetch(`/movie/${movieId}/watchlist/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
      },
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === "added") {
        watchlistBtn.classList.add("added");
        watchlistBtn.textContent = "‚úì In Watchlist";
      } else {
        watchlistBtn.classList.remove("added");
        watchlistBtn.textContent = "+ Add to Watchlist";
      }
    });
  });
}
</script>

{% endblock %}
 