{% extends "base.html" %}
{% load static %}
{% load movie_filters %}

{% block title %}{{ movie.title }} | MovieMeter{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="{% static 'movies/detail.css' %}" />
<link rel="stylesheet" href="{% static 'movies/review_card.css' %}" />
<link rel="stylesheet" href="{% static 'movies/likes_modal.css' %}" />
<link rel="stylesheet" href="{% static 'movies/all_reviews.css' %}">
{% endblock %}

{% block navbar %}
  {% include "includes/navbar.html" with mode="mini" %}
{% endblock %}

{% block content %}

<div class="detail-page" data-current-vote="{{ user_vote }}">

  <!-- HERO -->
  <section class="movie-hero">
    <div class="poster">
      {% if movie.poster_path %}
        <img src="https://image.tmdb.org/t/p/w500{{ movie.poster_path }}" alt="{{ movie.title }}" />
      {% else %}
        <div class="no-poster">No Image</div>
      {% endif %}
    </div>

    <div class="movie-info">
      <h1>{{ movie.title }}</h1>

      <p class="meta">
        {% if movie.release_date %}
          <span class="meta-date">{{ movie.release_date }}</span>
        {% endif %}

        {% if movie.is_released %}
          <span class="status-pill released">Released</span>
        {% else %}
          <span class="status-pill upcoming">Upcoming</span>
        {% endif %}
      </p>

      {% if movie.overview %}
        <p class="overview">{{ movie.overview }}</p>
      {% else %}
        <p class="overview muted">No overview available.</p>
      {% endif %}

      <div class="genres">
        {% for g in movie.categories.all %}
          <span>{{ g.name }}</span>
        {% endfor %}
      </div>

      <form method="post" action="{% url 'toggle-watchlist' movie.id %}" style="display:inline">
        {% csrf_token %}
        <button type="submit" class="watchlist-btn {% if in_watchlist %}added{% endif %}">
          {% if in_watchlist %}âœ“ In Watchlist{% else %}+ Add to Watchlist{% endif %}
        </button>
      </form>
    </div>
  </section>


  {% if movie.is_released %}
  <!-- AUDIENCE OPINION METER -->
  <section class="meter-section">
    <div class="meter-wrap">

      <div class="meter-head">
        <div>
          <h2>Audience Opinion</h2>
          <p class="meter-subtitle">Vote for this movie</p>
        </div>

        <div class="vote-summary">
          <div class="vote-tooltip">
            {% if user_vote %}
              <span class="vote-pill vote-{{ user_vote }}">
                Voted: {{ user_vote|title }}
              </span>
            {% else %}
              <span class="vote-pill">Vote Now</span>
            {% endif %}

            <div class="vote-tooltip-box">
              <div class="tip-title">Vote Breakdown</div>

              <div class="tip-row bad">
                <span>Bad</span>
                <span class="tip-count">{{ vote_counts.bad }}</span>
              </div>

              <div class="tip-row average">
                <span>Average</span>
                <span class="tip-count">{{ vote_counts.average }}</span>
              </div>

              <div class="tip-row good">
                <span>Good</span>
                <span class="tip-count">{{ vote_counts.good }}</span>
              </div>

              <div class="tip-row masterpiece">
                <span>Masterpiece</span>
                <span class="tip-count">{{ vote_counts.masterpiece }}</span>
              </div>

              <div class="tip-total">
                Total Votes: <strong>{{ total_votes }}</strong>
              </div>
            </div>

          </div>
        </div>
      </div>

      <form method="post" action="{% url 'vote-movie' movie.id %}">
        {% csrf_token %}

        <div class="meter-container">

          <div class="meter-row bad {% if user_vote == 'bad' %}selected{% endif %}">
            <button type="submit" name="vote" value="bad" class="meter-name" data-vote="bad">Bad</button>
            <div class="meter-track">
              <div class="fill" style="--w: {{ vote_percents|get_item:'bad' }}%"></div>
            </div>
            <span class="meter-pct">{{ vote_percents|get_item:'bad' }}%</span>
          </div>

          <div class="meter-row average {% if user_vote == 'average' %}selected{% endif %}">
            <button type="submit" name="vote" value="average" class="meter-name" data-vote="average">Average</button>
            <div class="meter-track">
              <div class="fill" style="--w: {{ vote_percents|get_item:'average' }}%"></div>
            </div>
            <span class="meter-pct">{{ vote_percents|get_item:'average' }}%</span>
          </div>

          <div class="meter-row good {% if user_vote == 'good' %}selected{% endif %}">
            <button type="submit" name="vote" value="good" class="meter-name" data-vote="good">Good</button>
            <div class="meter-track">
              <div class="fill" style="--w: {{ vote_percents|get_item:'good' }}%"></div>
            </div>
            <span class="meter-pct">{{ vote_percents|get_item:'good' }}%</span>
          </div>

          <div class="meter-row masterpiece {% if user_vote == 'masterpiece' %}selected{% endif %}">
            <button type="submit" name="vote" value="masterpiece" class="meter-name" data-vote="masterpiece">Masterpiece</button>
            <div class="meter-track">
              <div class="fill" style="--w: {{ vote_percents|get_item:'masterpiece' }}%"></div>
            </div>
            <span class="meter-pct">{{ vote_percents|get_item:'masterpiece' }}%</span>
          </div>

        </div>
      </form>

    </div>
  </section>
  {% endif %}


  
  {% if not movie.is_released %}
  <!-- HYPE METER (Upcoming Only) -->
  <section class="meter-section">
    <div class="meter-wrap">
      <div class="meter-head">
        <div>
          <h2>Hype Meter</h2>
          <p class="meter-subtitle">How excited are people for this movie?</p>
        </div>

        <div class="vote-summary">
          <span class="vote-pill">
            Hype Score: {{ hype_score }}%
          </span>
        </div>
      </div>

      <form method="post" action="{% url 'hype-vote-movie' movie.id %}">
        {% csrf_token %}

        <div class="meter-container">

          <div class="meter-row good {% if user_hype_vote == 'excited' %}selected{% endif %}">
            <button type="submit" name="vote" value="excited" class="meter-name">Excited</button>
            <div class="meter-track">
              <div class="fill" style="--w: {{ hype_score }}%"></div>
            </div>
            <span class="meter-pct">{{ hype_counts.excited }} Votes</span>
          </div>

          <div class="meter-row bad {% if user_hype_vote == 'not_excited' %}selected{% endif %}">
            <button type="submit" name="vote" value="not_excited" class="meter-name">Not Excited</button>
            <div class="meter-track">
              <div class="fill" style="--w: {{ hype_not_excited_percent }}%"></div>

            </div>
            <span class="meter-pct">{{ hype_counts.not_excited }}Votes</span>
          </div>

        </div>
      </form>
    </div>
  </section>

  {% endif %}


  <!-- CAST -->
  {% if movie.cast.exists %}
  <section class="cast-section">
    <h2>Cast</h2>
    <div class="cast-scroll-wrap">
      <div class="cast-scroll">
        {% for member in movie.cast.all %}
          <a href="{% url 'person-detail' member.person.id %}" class="cast-card-link">
            <div class="cast-card">
              {% if member.person.profile_path %}
                <img src="https://image.tmdb.org/t/p/w200{{ member.person.profile_path }}" alt="{{ member.person.name }}" />
              {% else %}
                <div class="cast-avatar">ðŸŽ­</div>
              {% endif %}
              <p class="cast-name">{{ member.person.name }}</p>
              <span class="cast-role">{{ member.character }}</span>
            </div>
          </a>
        {% endfor %}
      </div>
    </div>
  </section>
  {% endif %}

  <!-- CREW -->
  {% if grouped_crew %}
  <section class="cast-section">
    <h2>Crew</h2>
    <div class="cast-scroll-wrap">
      <div class="cast-scroll">
        {% for item in grouped_crew %}
          <a href="{% url 'person-detail' item.person.id %}" class="cast-card-link">
            <div class="cast-card">
              {% if item.person.profile_path %}
                <img src="https://image.tmdb.org/t/p/w200{{ item.person.profile_path }}" />
              {% else %}
                <div class="cast-avatar">ðŸŽ¬</div>
              {% endif %}
              <p class="cast-name">{{ item.person.name }}</p>
              <span class="cast-role">{{ item.jobs|join:" Â· " }}</span>
            </div>
          </a>
        {% endfor %}
      </div>
    </div>
  </section>
  {% endif %}


  {% if movie.is_released %}
  <!-- REVIEW FORM -->
  <section class="review-form" id="review-form">
    <h2>
      {% if my_review and edit_mode %}Edit Your Review{% else %}Rate & Review{% endif %}
    </h2>

    <form method="post" action="{% url 'submit-review' movie.id %}" novalidate>
      {% csrf_token %}

      <div class="stars-container">
        {% for i in "12345" %}
          <label class="star-label {% if edit_mode and my_review and my_review.rating >= forloop.counter %}active{% endif %}">
            <input type="radio" name="rating" value="{{ forloop.counter }}"
              {% if edit_mode and my_review and my_review.rating == forloop.counter %}checked{% endif %}>
            <span class="star">â˜…</span>
          </label>
        {% endfor %}

        <span class="rating-text">
          {% if my_review and edit_mode %}
            {{ my_review.rating }}/5
          {% else %}
            Select rating
          {% endif %}
        </span>
      </div>

      <p class="review-error" id="review-rating-error" hidden></p>

      <div class="review-textarea-wrap">
        <textarea name="review_text" maxlength="1000" placeholder="Write your review...">{% if edit_mode and my_review %}{{ my_review.review_text }}{% endif %}</textarea>
        <textarea id="ai-original-text" hidden></textarea>

        <p class="review-error" id="review-text-error" hidden></p>


        <div class="char-counter">
          <span id="char-count">
            {% if my_review and edit_mode %}
              {{ my_review.review_text|length }}
            {% else %}
              0
            {% endif %}
          </span>/1000
        </div>
      </div>

      <div class="review-form-footer">
        
        <label class="spoiler-check">
          <input type="checkbox" name="contains_spoiler"
            {% if edit_mode and my_review and my_review.contains_spoiler %}checked{% endif %}>
          <span>Contains spoilers</span>
        </label>

    

        <button type="submit" class="submit-review-btn">
          {% if edit_mode and my_review %}Update Review{% else %}Submit Review{% endif %}
        </button>
      </div>

    </form>
  </section>
<div class="review-ai-studio">
  <div class="ai-studio-top">
    <div class="ai-studio-title">AI Review </div>
    <div class="ai-studio-subtitle">Write your review in different styles</div>
  </div>

  <div class="ai-controls">
    <div class="ai-control-left">
      <select id="ai-mode" class="ai-select">
        <option value="rewrite">Rewrite (Clean + Polished)</option>
        <option value="shorten">Shorten (Compact)</option>
        <option value="funny">Funny Version</option>
        <option value="roast">Roast Version</option>
        <option value="professional">Professional</option>
        <option value="hype">Hype It Up</option>
        <option value="savage_1star">1-Star Savage</option>
      </select>
    </div>

    <div class="ai-control-right">
      <button type="button"
              class="ai-btn ai-primary"
              id="ai-generate-btn"
              data-url="{% url 'ai-review-assistant' movie.id %}">
        Generate
      </button>

      <button type="button"
              class="ai-btn ai-secondary"
              id="ai-proscons-btn"
              data-url="{% url 'ai-pros-cons' movie.id %}">
      Pros/Cons
      </button>

      <button type="button"
              class="ai-btn ai-danger"
              id="ai-undo-btn"
              disabled>
        Undo
      </button>
    </div>
  </div>

  <div class="ai-status" id="ai-status" hidden></div>
</div>



  <!-- REVIEWS SECTION -->

  <section class="reviews-section">
    <div class="reviews-wrap">
      <h2 class="reviews-title">
        Reviews
        <span class="reviews-subtitle">What people are saying</span>
      </h2>
         <div class="reviews-toolbar">

</div>

      {% if my_review %}
        <form method="get" class="sort-form" style="margin-bottom:50px;">
    <select name="sort" onchange="this.form.submit()">
      <option value="liked" {% if sort == "liked" %}selected{% endif %}>Most Liked</option>
      <option value="latest" {% if sort == "latest" %}selected{% endif %}>Latest</option>
    </select>
  </form>
        {% include "movies/review_card.html" with review=my_review movie=movie is_owner=True %}
      {% endif %}

   


      {% if other_reviews %}
        {% for review in other_reviews %}
          {% include "movies/review_card.html" with review=review movie=movie is_owner=False %}
        {% endfor %}
      {% else %}
        {% if not my_review %}
          <p class="no-reviews-text">No reviews yet. Be the first!</p>
        {% endif %}
      {% endif %}
    </div>
  </section>
  {% endif %}
{% if total_reviews_count > 0 %}
  <a href="{% url 'all-reviews' movie.id %}?sort={{ sort }}" class="show-all-btn">
    Show All Reviews ({{ total_reviews_count }})
  </a>
{% endif %}

</div>
<div id="ai-modal" class="ai-modal" hidden>
  <div class="ai-modal-backdrop" data-ai-close></div>

  <div class="ai-modal-card">
    <div class="ai-modal-head">
      <div class="ai-modal-title" id="ai-modal-title">Pros & Cons</div>
      <button type="button" class="ai-modal-close" data-ai-close>âœ•</button>
    </div>

    <div class="ai-modal-body" id="ai-modal-body">
      Loading...
    </div>
  </div>
</div>


{% endblock %}



{% block extra_js %}
<script src="{% static 'js/detail.js' %}"></script>
<script src="{% static 'js/detail_ai.js' %}"></script>
{% endblock %}
