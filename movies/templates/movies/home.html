{% extends "base.html" %}
{% load static %}

{% block title %}Movie Opinion Meter{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{% static 'movies/home.css' %}">
{% endblock %}

{% block navbar %}
  {% include "includes/navbar.html" with mode="full" %}
{% endblock %}

{% block content %}

<main class="page-container">

  {% if section_title %}
    <!-- ================= FILTERED RESULTS ================= -->
    <div class="content-wrapper">
      <div class="section-header">
        <h2 class="section-title">
          <span class="section-icon">üîç</span>
          {{ section_title }}
        </h2>
      </div>
      
      <section class="movie-grid">
        {% for movie in movies %}
          <a href="{% url 'movie-detail' movie.id %}" class="movie-card-link">
            <div class="movie-card">
              <div class="poster-container">
                {% if movie.poster_path %}
                  <img src="https://image.tmdb.org/t/p/w500{{ movie.poster_path }}" 
                       alt="{{ movie.title }}"
                       loading="lazy">
                {% else %}
                  <div class="no-poster">
                    <span>üé¨</span>
                  </div>
                {% endif %}
                
                <div class="card-overlay">
                  <span class="view-btn">View Details</span>
                </div>
              </div>

              <div class="card-info">
                <span class="status-badge {% if movie.is_released %}released{% else %}upcoming{% endif %}">
                  {% if movie.is_released %}Released{% else %}Upcoming{% endif %}
                </span>

                <h3 class="movie-title">{{ movie.title }}</h3>

                <p class="movie-genres">
                  {% for g in movie.categories.all|slice:":3" %}
                    {{ g.name }}{% if not forloop.last %} ‚Ä¢ {% endif %}
                  {% empty %}
                    No genres
                  {% endfor %}
                </p>
                
                {% if movie.release_date %}
                  <p class="release-date">{{ movie.release_date|date:"Y" }}</p>
                {% endif %}
              </div>
            </div>
          </a>
        {% empty %}
          <div class="no-results">
            <div class="no-results-icon">üé≠</div>
            <h3>No Movies Found</h3>
            <p>Try adjusting your filters or search query</p>
          </div>
        {% endfor %}
      </section>
    </div>

  {% else %}
    <!-- ================= SMART SECTIONS (DEFAULT VIEW) ================= -->
  {% if page_obj.number == 1 %}
    <!-- üî• TRENDING THIS WEEK -->
    {% if trending_movies %}
    <div class="content-wrapper">
      <div class="section-header">
        <h2 class="section-title">
          <span class="section-icon">üî•</span>
          Trending This Week
        </h2>
        <p class="section-subtitle">Most voted movies right now</p>
      </div>
      
      <section class="horizontal-scroll">
        <div class="scroll-container">
          {% for movie in trending_movies %}
            <a href="{% url 'movie-detail' movie.id %}" class="movie-card-link">
              <div class="movie-card horizontal">
                <div class="poster-container">
                  {% if movie.poster_path %}
                    <img src="https://image.tmdb.org/t/p/w500{{ movie.poster_path }}" 
                         alt="{{ movie.title }}"
                         loading="lazy">
                  {% else %}
                    <div class="no-poster"><span>üé¨</span></div>
                  {% endif %}
                  
                  <div class="card-overlay">
                    <span class="view-btn">View Details</span>
                  </div>
                </div>

                <div class="card-info">
                  <span class="status-badge released">Released</span>
                  <h3 class="movie-title">{{ movie.title }}</h3>
                  <p class="movie-genres">
                    {% for g in movie.categories.all|slice:":2" %}
                      {{ g.name }}{% if not forloop.last %} ‚Ä¢ {% endif %}
                    {% endfor %}
                  </p>
                  {% if movie.release_date %}
                    <p class="release-date">{{ movie.release_date|date:"Y" }}</p>
                  {% endif %}
                </div>
              </div>
            </a>
          {% endfor %}
        </div>
      </section>
    </div>
    {% endif %}
    
    <!-- üé¨ LATEST RELEASED -->
    {% if latest_released_movies %}
    <div class="content-wrapper">
      <div class="section-header">
        <h2 class="section-title">
          <span class="section-icon">üé¨</span>
          Latest Released
        </h2>
        <p class="section-subtitle">Recently hit theaters</p>
      </div>
      
      <section class="horizontal-scroll">
        <div class="scroll-container">
          {% for movie in latest_released_movies %}
            <a href="{% url 'movie-detail' movie.id %}" class="movie-card-link">
              <div class="movie-card horizontal">
                <div class="poster-container">
                  {% if movie.poster_path %}
                    <img src="https://image.tmdb.org/t/p/w500{{ movie.poster_path }}" 
                         alt="{{ movie.title }}"
                         loading="lazy">
                  {% else %}
                    <div class="no-poster"><span>üé¨</span></div>
                  {% endif %}
                  
                  <div class="card-overlay">
                    <span class="view-btn">View Details</span>
                  </div>
                </div>

                <div class="card-info">
                  <span class="status-badge released">Released</span>
                  <h3 class="movie-title">{{ movie.title }}</h3>
                  <p class="movie-genres">
                    {% for g in movie.categories.all|slice:":2" %}
                      {{ g.name }}{% if not forloop.last %} ‚Ä¢ {% endif %}
                    {% endfor %}
                  </p>
                  {% if movie.release_date %}
                    <p class="release-date">{{ movie.release_date|date:"Y" }}</p>
                  {% endif %}
                </div>
              </div>
            </a>
          {% endfor %}
        </div>
      </section>
    </div>
    {% endif %}
    
    <!-- ‚è≥ COMING VERY SOON -->
    {% if coming_soon_movies %}
    <div class="content-wrapper">
      <div class="section-header">
        <h2 class="section-title">
          <span class="section-icon">‚è≥</span>
          Coming Very Soon
        </h2>
        <p class="section-subtitle">Releasing in the next 60 days</p>
      </div>
      
      <section class="horizontal-scroll">
        <div class="scroll-container">
          {% for movie in coming_soon_movies %}
            <a href="{% url 'movie-detail' movie.id %}" class="movie-card-link">
              <div class="movie-card horizontal">
                <div class="poster-container">
                  {% if movie.poster_path %}
                    <img src="https://image.tmdb.org/t/p/w500{{ movie.poster_path }}" 
                         alt="{{ movie.title }}"
                         loading="lazy">
                  {% else %}
                    <div class="no-poster"><span>üé¨</span></div>
                  {% endif %}
                  
                  <div class="card-overlay">
                    <span class="view-btn">View Details</span>
                  </div>
                </div>

                <div class="card-info">
                  <span class="status-badge upcoming">Upcoming</span>
                  <h3 class="movie-title">{{ movie.title }}</h3>
                  <p class="movie-genres">
                    {% for g in movie.categories.all|slice:":2" %}
                      {{ g.name }}{% if not forloop.last %} ‚Ä¢ {% endif %}
                    {% endfor %}
                  </p>
                  {% if movie.release_date %}
                    <p class="release-date">{{ movie.release_date|date:"M d, Y" }}</p>
                  {% endif %}
                </div>
              </div>
            </a>
          {% endfor %}
        </div>
      </section>
    </div>
    {% endif %}
    
    <!-- üöÄ MAJOR UPCOMING RELEASES -->
    {% if major_upcoming_movies %}
    <div class="content-wrapper">
      <div class="section-header">
        <h2 class="section-title">
          <span class="section-icon">üöÄ</span>
          Major Upcoming Releases
        </h2>
        <p class="section-subtitle">Big releases on the horizon</p>
      </div>
      
      <section class="horizontal-scroll">
        <div class="scroll-container">
          {% for movie in major_upcoming_movies %}
            <a href="{% url 'movie-detail' movie.id %}" class="movie-card-link">
              <div class="movie-card horizontal">
                <div class="poster-container">
                  {% if movie.poster_path %}
                    <img src="https://image.tmdb.org/t/p/w500{{ movie.poster_path }}" 
                         alt="{{ movie.title }}"
                         loading="lazy">
                  {% else %}
                    <div class="no-poster"><span>üé¨</span></div>
                  {% endif %}
                  
                  <div class="card-overlay">
                    <span class="view-btn">View Details</span>
                  </div>
                </div>

                <div class="card-info">
                  <span class="status-badge upcoming">Upcoming</span>
                  <h3 class="movie-title">{{ movie.title }}</h3>
                  <p class="movie-genres">
                    {% for g in movie.categories.all|slice:":2" %}
                      {{ g.name }}{% if not forloop.last %} ‚Ä¢ {% endif %}
                    {% endfor %}
                  </p>
                  {% if movie.release_date %}
                    <p class="release-date">{{ movie.release_date|date:"M Y" }}</p>
                  {% endif %}
                </div>
              </div>
            </a>
          {% endfor %}
        </div>
      </section>
    </div>
    {% endif %}
  {% endif %}
    <!-- üéû ALL MOVIES (GRID) -->
    <div class="content-wrapper">
      <div class="section-header">
        <h2 class="section-title">
          <span class="section-icon">üéûÔ∏è</span>
          All Movies
        </h2>
        <p class="section-subtitle">Explore our complete collection</p>
      </div>
      
      <section class="movie-grid">
        {% for movie in movies %}
          <a href="{% url 'movie-detail' movie.id %}" class="movie-card-link">
            <div class="movie-card">
              <div class="poster-container">
                {% if movie.poster_path %}
                  <img src="https://image.tmdb.org/t/p/w500{{ movie.poster_path }}" 
                       alt="{{ movie.title }}"
                       loading="lazy">
                {% else %}
                  <div class="no-poster"><span>üé¨</span></div>
                {% endif %}
                
                <div class="card-overlay">
                  <span class="view-btn">View Details</span>
                </div>
              </div>

              <div class="card-info">
                <span class="status-badge {% if movie.is_released %}released{% else %}upcoming{% endif %}">
                  {% if movie.is_released %}Released{% else %}Upcoming{% endif %}
                </span>

                <h3 class="movie-title">{{ movie.title }}</h3>

                <p class="movie-genres">
                  {% for g in movie.categories.all|slice:":3" %}
                    {{ g.name }}{% if not forloop.last %} ‚Ä¢ {% endif %}
                  {% empty %}
                    No genres
                  {% endfor %}
                </p>
                
                {% if movie.release_date %}
                  <p class="release-date">{{ movie.release_date|date:"Y" }}</p>
                {% endif %}
              </div>
            </div>
          </a>
        {% empty %}
          <div class="no-results">
            <div class="no-results-icon">üé≠</div>
            <h3>No Movies Yet</h3>
            <p>Run the sync command to populate the database</p>
            <code>python manage.py sync_tmdb_movies</code>
          </div>
        {% endfor %}
      </section>
    </div>
    
  {% endif %}

  <!-- ================= PAGINATION ================= -->
  {% if page_obj.paginator.num_pages > 1 %}
  <div class="pagination-wrapper">
    <div class="pagination">
      {% if page_obj.has_previous %}
        <a href="?page=1
          {% if request.GET.search %}&search={{ request.GET.search }}{% endif %}
          {% if request.GET.genre %}&genre={{ request.GET.genre }}{% endif %}
          {% if request.GET.released %}&released={{ request.GET.released }}{% endif %}" 
          class="page-btn">
          ‚èÆÔ∏è First
        </a>
        
        <a href="?page={{ page_obj.previous_page_number }}
          {% if request.GET.search %}&search={{ request.GET.search }}{% endif %}
          {% if request.GET.genre %}&genre={{ request.GET.genre }}{% endif %}
          {% if request.GET.released %}&released={{ request.GET.released }}{% endif %}" 
          class="page-btn">
          ‚Üê Prev
        </a>
      {% endif %}

      <span class="page-info">
        Page <strong>{{ page_obj.number }}</strong> of <strong>{{ page_obj.paginator.num_pages }}</strong>
      </span>

      {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}
          {% if request.GET.search %}&search={{ request.GET.search }}{% endif %}
          {% if request.GET.genre %}&genre={{ request.GET.genre }}{% endif %}
          {% if request.GET.released %}&released={{ request.GET.released }}{% endif %}" 
          class="page-btn">
          Next ‚Üí
        </a>
        
        <a href="?page={{ page_obj.paginator.num_pages }}
          {% if request.GET.search %}&search={{ request.GET.search }}{% endif %}
          {% if request.GET.genre %}&genre={{ request.GET.genre }}{% endif %}
          {% if request.GET.released %}&released={{ request.GET.released }}{% endif %}" 
          class="page-btn">
          Last ‚è≠Ô∏è
        </a>
      {% endif %}
    </div>
  </div>
  {% endif %}

</main>

{% endblock %}