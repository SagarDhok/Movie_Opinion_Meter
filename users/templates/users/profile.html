{% extends 'base.html' %}
{% load static %}

{% block title %}My Profile | MovieMeter{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/navbar.css' %}">
<link rel="stylesheet" href="{% static 'users/profile.css' %}">
{% endblock %}

{% block navbar %}
  {% include "includes/navbar.html" with mode="mini" %}
{% endblock %}

{% block content %}
<div class="profile-container">

    <div class="profile-card">
        <div class="card-header">
            <h2>Account Settings</h2>
            <p>Manage your profile and preferences</p>
        </div>

        <div class="avatar-section">
            <div class="image-wrapper">
                {% if request.user.profile_image %}
                    <img src="{{ request.user.profile_image }}" alt="Profile" id="avatarPreview">
                {% else %}
                    <div class="avatar-placeholder">
                        <span>{{ request.user.first_name|slice:":1"|upper }}</span>
                    </div>
                {% endif %}

            </div>

            <h3 class="username">
                {{ request.user.first_name }} {{ request.user.last_name }}
            </h3>

            <div class="avatar-actions">

                <!-- Upload Photo Form -->
                    <form method="post" enctype="multipart/form-data" action="{% url 'profile' %}" id="uploadForm">
                        {% csrf_token %}
                        <input type="hidden" name="upload_photo" value="1">

                        <input type="file" name="profile_image" id="fileInput" accept="image/*" hidden>

                        <button type="button" class="btn-primary-glow" id="uploadBtn">Upload</button>
                    </form>

                <!-- Remove Photo Form -->
                {% if request.user.profile_image %}
                <form method="post" action="{% url 'profile' %}">
                    {% csrf_token %}
                    <input type="hidden" name="remove_image" value="1">
                    <button type="submit" class="btn-danger-outline">Remove</button>
                </form>
                {% endif %}
            </div>
        </div>

        <div class="profile-details">
            <div class="detail-row">
                <div class="label-group">
                    <span class="label">Full Name</span>
                    <span class="value">{{ request.user.first_name }} {{ request.user.last_name }}</span>
                </div>

                <button type="button" class="status-pill edit-pill" onclick="openNameModal()">
                    Edit
                </button>
            </div>

            <div class="detail-row">
                <div class="label-group">
                    <span class="label">Email</span>
                    <span class="value">{{ request.user.email }}</span>
                </div>

                <span class="status-pill {% if request.user.is_email_verified %}verified{% else %}unverified{% endif %}">
                    {{ request.user.is_email_verified|yesno:"Verified,Unverified" }}
                </span>
            </div>
        </div>

        <div class="profile-stats">
                    <a href="{% url 'my-reviews' %}" class="stat-box stat-link">
                <span class="stat-num">{{ review_count }}</span>
                <span class="stat-label">Reviews</span>
            </a>


            <a href="{% url 'watchlist' %}" class="stat-box stat-link">
                <span class="stat-num">{{ watchlist_count }}</span>
                <span class="stat-label">Watchlist</span>
            </a>
        </div>

        <div class="profile-footer">
            <a href="{% url 'forgot-password' %}" class="btn-secondary">Change Password</a>
            <a href="{% url 'logout' %}" class="btn-danger" onclick="confirmLogout(event)">Logout</a>
        </div>
    </div>
</div>

<!-- ===== EDIT NAME MODAL ===== -->
<div id="nameModal" class="modal-overlay" onclick="if(event.target === this) closeNameModal()">
    <div class="modal-card">
        <div class="modal-header">
            <h3>Update Profile Name</h3>
            <p>Personalize how you appear on MovieMeter</p>
        </div>

        <!-- Name Update Form -->
        <form method="post" action="{% url 'profile' %}">
            {% csrf_token %}
            <input type="hidden" name="update_name" value="1">

            <div class="input-container">
                <div class="input-group">
                    <label>First Name</label>
                    <input type="text" name="first_name" placeholder="Enter first name"
                           value="{{ request.user.first_name }}" required>
                </div>

                <div class="input-group">
                    <label>Last Name</label>
                    <input type="text" name="last_name" placeholder="Enter last name"
                           value="{{ request.user.last_name }}">
                </div>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn-cancel" onclick="closeNameModal()">Cancel</button>
                <button type="submit" class="btn-primary-glow">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<script>
function confirmLogout(event) {
    event.preventDefault();
    const logoutUrl = event.currentTarget.getAttribute('href');

    Swal.fire({
        title: 'Logout?',
        text: "Do you really want to sign out?",
        icon: 'warning',
        showCancelButton: true,
        background: '#0f172a',
        color: '#f8fafc',
        confirmButtonColor: '#f87171',
        cancelButtonColor: '#334155',
        confirmButtonText: 'Yes, Logout!',
        cancelButtonText: 'Stay here'
    }).then((result) => {
        if (result.isConfirmed) {
            window.location.href = logoutUrl;
        }
    })
}

function openNameModal() {
    document.getElementById("nameModal").style.display = "flex";
}

function closeNameModal() {
    document.getElementById("nameModal").style.display = "none";

    
}

const uploadBtn = document.getElementById("uploadBtn");
const fileInput = document.getElementById("fileInput");
const uploadForm = document.getElementById("uploadForm");

uploadBtn.addEventListener("click", () => fileInput.click());

fileInput.addEventListener("change", () => {
    if (fileInput.files.length > 0) uploadForm.submit();
});
</script>
{% endblock %}
